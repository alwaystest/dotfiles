#!/usr/bin/env bash

set -euo pipefail

# è§£æå‘½ä»¤è¡Œå‚æ•°
DEBUG=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--debug)
            DEBUG=true
            shift
            ;;
        -h|--help)
            echo "ç”¨æ³•: adbi [é€‰é¡¹]"
            echo ""
            echo "é€‰é¡¹:"
            echo "  -d, --debug    å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºè¯¦ç»†æ‰§è¡Œä¿¡æ¯"
            echo "  -h, --help     æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
            exit 0
            ;;
        *)
            echo "æœªçŸ¥å‚æ•°: $1" >&2
            echo "ä½¿ç”¨ -h æˆ– --help æŸ¥çœ‹å¸®åŠ©" >&2
            exit 1
            ;;
    esac
done

# è°ƒè¯•å‡½æ•°
debug() {
    if [ "$DEBUG" = true ]; then
        echo "[DEBUG] $*" >&2
    fi
}

# å¯ç”¨ bash è°ƒè¯•æ¨¡å¼
if [ "$DEBUG" = true ]; then
    set -x
fi

debug "å¼€å§‹æ‰§è¡Œè„šæœ¬"
debug "å½“å‰å·¥ä½œç›®å½•: $PWD"

# æ£€æŸ¥ä¾èµ–
debug "æ£€æŸ¥ä¾èµ–å·¥å…·..."
for cmd in fzf rg adb; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "é”™è¯¯: æœªæ‰¾åˆ° $cmd" >&2
        exit 1
    fi
    debug "âœ“ æ‰¾åˆ° $cmd: $(which $cmd)"
done

# è‡ªåŠ¨æ£€æµ‹ Android é¡¹ç›®æ ¹ç›®å½•
debug "æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•..."
find_project_root() {
    local dir="$PWD"
    debug "  ä»ç›®å½•å¼€å§‹æŸ¥æ‰¾: $dir"
    while [ "$dir" != "/" ]; do
        if [ -f "$dir/build.gradle" ] || [ -f "$dir/settings.gradle" ] || [ -f "$dir/settings.gradle.kts" ]; then
            debug "  âœ“ æ‰¾åˆ°é¡¹ç›®æ ¹ç›®å½•: $dir"
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    debug "  âš  æœªæ‰¾åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œä½¿ç”¨å½“å‰ç›®å½•: $PWD"
    echo "$PWD"
}

PROJECT_ROOT=$(find_project_root)
debug "é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"

# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•è¿›è¡Œæœç´¢
cd "$PROJECT_ROOT"
debug "å·²åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•"

# ä½¿ç”¨ ripgrep æŸ¥æ‰¾ APK æ–‡ä»¶ï¼ˆæ›´å¿«ï¼‰
# ä½¿ç”¨ --no-ignore å¿½ç•¥ .gitignore è§„åˆ™ï¼ˆå› ä¸º build/ ç›®å½•è¢«å¿½ç•¥ï¼‰
# ä½¿ç”¨ --glob ç›´æ¥åŒ¹é…è·¯å¾„å’Œæ–‡ä»¶åï¼Œè‡ªåŠ¨æ’é™¤ intermediatesï¼ˆå› ä¸º intermediates ä¸åœ¨ build/outputs/apk è·¯å¾„ä¸‹ï¼‰
echo "ğŸ” æ­£åœ¨æœç´¢ APK æ–‡ä»¶..."
debug "å¼€å§‹æœç´¢ APK æ–‡ä»¶..."
start_time=$(date +%s)
apk_list=$(rg --files --no-ignore --glob '**/build/outputs/apk/**/*.apk' 2>/dev/null | sort)
end_time=$(date +%s)
search_duration=$((end_time - start_time))

apk_count=$(echo "$apk_list" | grep -c . || echo "0")
echo "âœ“ æœç´¢å®Œæˆï¼Œè€—æ—¶: ${search_duration}ç§’ï¼Œæ‰¾åˆ° ${apk_count} ä¸ª APK æ–‡ä»¶"
debug "æœç´¢å®Œæˆï¼Œè€—æ—¶: ${search_duration}ç§’ï¼Œæ‰¾åˆ° ${apk_count} ä¸ª APK æ–‡ä»¶"

if [ -z "$apk_list" ]; then
    echo "æœªæ‰¾åˆ°ä»»ä½• APK æ–‡ä»¶" >&2
    echo "å½“å‰æœç´¢ç›®å½•: $PROJECT_ROOT" >&2
    echo "æç¤º: è¯·å…ˆè¿è¡Œ assemble ä»»åŠ¡æ„å»º APK" >&2
    exit 1
fi

# æ˜¾ç¤ºæ‰¾åˆ°çš„ APK åˆ—è¡¨ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
if [ "$DEBUG" = true ]; then
    echo ""
    echo "æ‰¾åˆ°çš„ APK æ–‡ä»¶åˆ—è¡¨:" >&2
    echo "$apk_list" | nl -w2 -s'. ' >&2
    echo ""
fi

# ä½¿ç”¨ fzf é€‰æ‹© APK
debug "å¯åŠ¨ fzf é€‰æ‹©å™¨..."
if [ "$DEBUG" = true ]; then
    debug "fzf å‘½ä»¤: echo apk_list | fzf ..."
fi

selected_apk=$(echo "$apk_list" | fzf \
    --height 40% \
    --border \
    --header="é€‰æ‹©è¦å®‰è£…çš„ APK (æ–¹å‘é”®é€‰æ‹©ï¼Œå›è½¦ç¡®è®¤ï¼ŒESC å–æ¶ˆï¼ŒCtrl+R åˆ·æ–°)" \
    --preview='echo "æ–‡ä»¶ä¿¡æ¯:"; ls -lh {} 2>/dev/null | awk "{print \"å¤§å°: \" \$5 \"\nä¿®æ”¹æ—¶é—´: \" \$6 \" \" \$7 \" \" \$8 \"\nå®Œæ•´è·¯å¾„: \" \$9}" || echo "æ— æ³•è¯»å–æ–‡ä»¶ä¿¡æ¯"' \
    --preview-window=right:50% \
    --prompt="APK> " \
    --bind="ctrl-r:reload(rg --files --no-ignore --glob '**/build/outputs/apk/**/*.apk' 2>/dev/null | sort)")

debug "fzf é€‰æ‹©å®Œæˆï¼Œç»“æœ: ${selected_apk:-<ç©º>}"

if [ -z "$selected_apk" ]; then
    debug "ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©"
    echo "å·²å–æ¶ˆ"
    exit 0
fi

# ç¡®ä¿è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„
if [[ "$selected_apk" != /* ]]; then
    selected_apk="$PROJECT_ROOT/$selected_apk"
fi
debug "å®Œæ•´è·¯å¾„: $selected_apk"

# æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
echo ""
echo "========================================"
echo "å‡†å¤‡å®‰è£… APK:"
echo "è·¯å¾„: $selected_apk"
if [ -f "$selected_apk" ]; then
    file_info=$(ls -lh "$selected_apk")
    echo "å¤§å°: $(echo "$file_info" | awk '{print $5}')"
    echo "ä¿®æ”¹æ—¶é—´: $(echo "$file_info" | awk '{print $6, $7, $8}')"
    debug "æ–‡ä»¶å­˜åœ¨ï¼Œå¤§å°: $(echo "$file_info" | awk '{print $5}')"
else
    debug "é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨"
    echo "é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨" >&2
    exit 1
fi
echo "========================================"
echo ""

# æ£€æŸ¥è®¾å¤‡è¿æ¥ï¼ˆå¸¦è€—æ—¶ç»Ÿè®¡ï¼‰
echo "ğŸ” æ­£åœ¨æ£€æŸ¥è®¾å¤‡è¿æ¥..."
debug "å¼€å§‹æ£€æŸ¥è®¾å¤‡è¿æ¥..."
device_check_start=$(date +%s)
if ! adb devices 2>/dev/null | grep -q "device$"; then
    device_check_end=$(date +%s)
    device_check_duration=$((device_check_end - device_check_start))
    echo "âœ— æ£€æŸ¥å®Œæˆï¼Œè€—æ—¶: ${device_check_duration}ç§’"
    echo "âŒ é”™è¯¯: æœªæ£€æµ‹åˆ°å·²è¿æ¥çš„ Android è®¾å¤‡" >&2
    echo "   è¯·è¿æ¥è®¾å¤‡å¹¶å¯ç”¨ USB è°ƒè¯•åé‡è¯•" >&2
    debug "è®¾å¤‡æ£€æŸ¥: æœªè¿æ¥ï¼Œè€—æ—¶: ${device_check_duration}ç§’"
    exit 1
fi
device_check_end=$(date +%s)
device_check_duration=$((device_check_end - device_check_start))
echo "âœ“ æ£€æŸ¥å®Œæˆï¼Œè€—æ—¶: ${device_check_duration}ç§’ï¼Œè®¾å¤‡å·²è¿æ¥"
debug "è®¾å¤‡æ£€æŸ¥: å·²è¿æ¥ï¼Œè€—æ—¶: ${device_check_duration}ç§’"

# å®‰è£… APK
debug "å¼€å§‹å®‰è£… APK..."
debug "æ‰§è¡Œå‘½ä»¤: adb install -r \"$selected_apk\""
if adb install -r "$selected_apk"; then
    echo ""
    echo "âœ… å®‰è£…æˆåŠŸ!"
    debug "å®‰è£…æˆåŠŸ"
else
    echo ""
    echo "âŒ å®‰è£…å¤±è´¥!"
    debug "å®‰è£…å¤±è´¥"
    exit 1
fi
